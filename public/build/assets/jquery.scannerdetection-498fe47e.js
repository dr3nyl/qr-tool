(function(f){f.fn.scannerDetection=function(e){if(typeof e=="string")return this.each(function(){this.scannerDetectionTest(e)}),this;if(e===!1)return this.each(function(){this.scannerDetectionOff()}),this;var h={onComplete:!1,onError:!1,onReceive:!1,onKeyDetect:!1,timeBeforeScanTest:100,avgTimeByChar:30,minLength:6,endChar:[9,13],startChar:[],ignoreIfFocusOn:!1,scanButtonKeyCode:!1,scanButtonLongPressThreshold:3,onScanButtonLongPressed:!1,stopPropagation:!1,preventDefault:!1};return typeof e=="function"&&(e={onComplete:e}),typeof e!="object"?e=f.extend({},h):e=f.extend({},h,e),this.each(function(){var t=this,c=f(t),a=0,o=0,r="",l=!1,u=!1,i=0,g=function(){a=0,r="",i=0};t.scannerDetectionOff=function(){c.unbind("keydown.scannerDetection"),c.unbind("keypress.scannerDetection")},t.isFocusOnIgnoredElement=function(){if(!e.ignoreIfFocusOn)return!1;if(typeof e.ignoreIfFocusOn=="string")return f(":focus").is(e.ignoreIfFocusOn);if(typeof e.ignoreIfFocusOn=="object"&&e.ignoreIfFocusOn.length){for(var n=f(":focus"),s=0;s<e.ignoreIfFocusOn.length;s++)if(n.is(e.ignoreIfFocusOn[s]))return!0}return!1},t.scannerDetectionTest=function(n){return n&&(a=o=0,r=n),i||(i=1),r.length>=e.minLength&&o-a<r.length*e.avgTimeByChar?(e.onScanButtonLongPressed&&i>e.scanButtonLongPressThreshold?e.onScanButtonLongPressed.call(t,r,i):e.onComplete&&e.onComplete.call(t,r,i),c.trigger("scannerDetectionComplete",{string:r}),g(),!0):(e.onError&&e.onError.call(t,r),c.trigger("scannerDetectionError",{string:r}),g(),!1)},c.data("scannerDetection",{options:e}).unbind(".scannerDetection").bind("keydown.scannerDetection",function(n){if(e.scanButtonKeyCode!==!1&&n.which==e.scanButtonKeyCode)i++,n.preventDefault(),n.stopImmediatePropagation();else if(a&&e.endChar.indexOf(n.which)!==-1||!a&&e.startChar.indexOf(n.which)!==-1){var s=jQuery.Event("keypress",n);s.type="keypress.scannerDetection",c.triggerHandler(s),n.preventDefault(),n.stopImmediatePropagation()}e.onKeyDetect&&e.onKeyDetect.call(t,n),c.trigger("scannerDetectionKeyDetect",{evt:n})}).bind("keypress.scannerDetection",function(n){this.isFocusOnIgnoredElement()||(e.stopPropagation&&n.stopImmediatePropagation(),e.preventDefault&&n.preventDefault(),a&&e.endChar.indexOf(n.which)!==-1?(n.preventDefault(),n.stopImmediatePropagation(),l=!0):!a&&e.startChar.indexOf(n.which)!==-1?(n.preventDefault(),n.stopImmediatePropagation(),l=!1):(typeof n.which<"u"&&(r+=String.fromCharCode(n.which)),l=!1),a||(a=Date.now()),o=Date.now(),u&&clearTimeout(u),l?(t.scannerDetectionTest(),u=!1):u=setTimeout(t.scannerDetectionTest,e.timeBeforeScanTest),e.onReceive&&e.onReceive.call(t,n),c.trigger("scannerDetectionReceive",{evt:n}))})}),this}})(jQuery);
